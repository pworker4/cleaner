name: ğŸ§¹ Clean Discord Channels

on:
  schedule:
    # Runs at 00:00 Asia/Jerusalem (UTC+3) which is 21:00 in UTC time
    - cron: '0 21 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  clear-channel:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm install

      - name: Clear Discord channel and post message
        env:
          DISCORD_TOKEN: ${{ vars.DISCORD_TOKEN }}
          CHANNELS_IDS_2_CLEAN: ${{ vars.CHANNELS_IDS_2_CLEAN }}
        run: |
          node <<'EOF'
          const { Client, GatewayIntentBits } = require('discord.js');
          const client = new Client({
            intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages]
          });

          client.once('ready', async () => {
            const ch = client.channels.cache.get(process.env.CHANNELS_IDS_2_CLEAN);
            if (!ch?.isTextBased()) return process.exit(1);

            let batch;
            do {
              batch = await ch.messages.fetch({ limit: 100 });
              if (batch.size) await ch.bulkDelete(batch);
            } while (batch.size >= 2);

            // ×œ××—×¨ ×”× ×™×§×•×™ ×©×•×œ×—×™× ××ª ×”×”×•×“×¢×” ×”××‘×•×§×©×ª
            await ch.send(`×—×“×¨ ××¦×‘ ×”×™×•× ×©×‘×• × ×¨×©×•× ×¡×§×™×¨×” ×‘×¤×ª×™×—×ª ×™×•× ××¡×—×¨ ×•×¡×’×™×¨×ª ×™×•× ××¡×—×¨,\n×”××™×“×¢ ×‘×—×“×¨ ×™××—×§ ×‘×ª×—×™×œ×ª ×”×™×•× ×”×‘× (××•×˜×•××˜×™×ª ×‘-00:00)\n×œ×›×œ ××™ ×©×™×© ×“×¢×”, ×ª×•×‘× ×” ××• ××™×“×¢ ×©×™×›×•×œ ×œ×”×¦×‘×™×¢ ××™×š ×™×•× ×”××¡×—×¨ ×¢×•××“ ×œ×”×™×¨××•×ª â€“ ×©×™×›×ª×•×‘ ×›×“×™ ×œ×™×“×¢ ××ª ×”××—×¨×™×.\n×œ× ×—×™×™×‘ ×œ×”×™×•×ª ×‘×¤×•×¨××˜ ××¡×•×™× â€“ ××œ× ×¨×©××™× ×›×œ×œ×™×™×, ×œ××©×œ ×©×¢×¨ ×”×§×¨×™×¤×˜×• ×•×”××“×“×™× ×‘×¤×ª×™×—×ª ×™×•×, ×—×•×–×™× ×¢×ª×™×“×™×™×, ××’\"×— ×•×›×•'.\n×›×›×” × ×•×›×œ ×œ×”×™×›× ×¡ ×‘×ª×—×™×œ×ª ×™×•× ×•×œ×¨××•×ª ××” ×× ×—× ×• ×—×•×©×‘×™× ×‘××‘×˜ ××”×™×¨ ×©×™×”×™×” ×”×™×•×, ×¢× ××™×“×¢ ×¢×“×›× ×™ ×‘×œ×‘×“\n\n×‘×ª×—×™×œ×ª ×™×•× ××¡×—×¨ ××¤×©×¨ ×œ×¦×œ× ××˜×¨×™×™×“×™× ×’-×•×•×™×•, ××• ×: \nhttps://www.marketwatch.com/tools/screener/premarket\nhttps://www.barchart.com/futures/heat-map\n\n×¤×§×•×“×•×ª ×©××¤×©×¨ ×œ×”×¨×™×¥ ×‘×ª×—×™×œ×ª ×™×•× ××¡×—×¨:\n/c arguments: SPX 1d rsi macd bbands ema\n/c arguments: NDX 1d rsi macd bbands ema\n/hmap type: stocks market: S&P 500 Index size: market cap group: sector\n/hmap type: crypto size: market cap\n/lookup fgi market: stocks\n/lookup market-movers category: stocks gainers`);

            console.log('Cleared channel and posted message', process.env.CHANNELS_IDS_2_CLEAN);
            process.exit(0);
          });

          client.login(process.env.DISCORD_TOKEN);
          EOF
